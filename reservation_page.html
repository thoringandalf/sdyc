<script>
  
// Load URL Param
  
let ct = null; // ct stands for 'charter type'
if(tour_type !== 3) {
	ct = parseInt(tour_type) + 2;
} else if (tour_type === 3) {
	ct = 1.5;
}
  
// Google Firestore Configuration
  
let firebaseConfig={
  apiKey:"AIzaSyBBX2ENxIX4LkpJUAJPyFXjbHTl9Orm1vc",
  authDomain:"sdyc-192f7.firebaseapp.com",
  projectId:"sdyc-192f7",storageBucket:"sdyc-192f7.appspot.com",
  messagingSenderId:"301361682532",
  appId:"1:301361682532:web:7c63df90592c36c9bfe771"
}
firebase.initializeApp(firebaseConfig);
let db=firebase.firestore()
  
// Utility Functions
  
let e=(el)=>{return document.getElementById(el)}

// Global Constants

const months=["January","February","March","April","May","June","July","August","September","October","November","December"]
const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]

const charterType=e("charterType")
const emailField=e("email")
const phoneField=e("phoneField")
const fnameField=e("firstNameField")
const lnameField=e("lastNameField")
const dateTimeField=e("resDateTime")
const timeField=e("timeField")
const numPassengers=e("nop")
const notesField=e("notes")
const timeSlots=e("timeSlots")
const left=e('left')
const right=e('right')

// Global Variables 

let form={
  yachtType:"",
  idt:"",
  rate:null,
  id:"",
  whenPretty:"",
  charterType:"",
  firstName:"",
  lastName:"",
  email:"",
  phone:null,
  startHr:null,
  startMin:null,
  day:null,
  month:null,
  year:null,
  duration:null,
  numPassengers:null,
  notes:"",
  dateCreated:null
}
let currentDay=1;
let currentMonth=2;
let currentYear=2021;
let currentCharter=ct;
let currentTime="";
let numberOfDays=0;
let firstDay=0;
let prevPhoneLength=0;
let currentSlot=0;
let today={
  day: null, month: null, yr: null, dow:null
}
let cb='Dragonfly'

// Event Listners

e('rightArrow').onclick=()=>{refreshCalendar(true)}
e('leftArrow').onclick=()=>{null}

charterType.onchange=()=>{
  currentCharter=charterType.value;
  currentHr=null;
  currentMin=null;
  timeField.innerHTML="";
  if(currentSlot!=0){
    e(`tSlot${currentSlot}`).classList.remove('isSelected')
  }
  refreshDateSlots();
  if(new Date(currentYear,currentMonth, currentDay).getDay()==6 && currentCharter==1.5){
    dateTimeField.innerHTML="Select from calendar";
    for(let i=1; i<49; i++){
      e(`tSlot${i}`).classList.add("isHidden")
    }
  }
  else{
    if(numPassengers.value>6){getAvailableTimes("operatingHrsB")}
    else{getAvailableTimes()
}}}

e('requestCharter').onclick=()=>{handleCharterRequest()}

left.onclick=()=>{left.classList.add("isHidden");right.classList.remove("isHidden")}
right.onclick=()=>{right.classList.add("isHidden");left.classList.remove("isHidden")}

// Main

const setNumberOfDays=()=>{
  if(currentMonth<7 && currentMonth%2==0 || currentMonth>6 && currentMonth%2==1){ numberOfDays=31 }
  else if(currentMonth!=1&&(currentMonth<6&&currentMonth%2==1||currentMonth>7&&currentMonth%2==0)){numberOfDays=30}
  else if (currentMonth==1){if(currentYear%4==0){numberOfDays=29}else{numberOfDays=28}}
}

const refreshCalendar=(goingUp)=>{
  if(goingUp){
    if(currentMonth==11){currentMonth=0;currentYear+=1}
    else{currentMonth+=1}
  }
  else{
    if(currentMonth==0){
      currentMonth=11;
      currentYear-=1
    }
    else{currentMonth-=1}
  }
  e('calendarMonthYear').innerHTML=months[currentMonth]+" "+currentYear;
  if(currentYear==today.yr&&currentMonth==today.month){
    e('leftArrow').classList.add('blocked'); e('leftArrow').onclick=()=>{null}}
else{e("leftArrow").onclick=()=>{refreshCalendar(false)};e("leftArrow").classList.remove('blocked');}
refreshDateSlots()}

const calculateFirstDay=()=>{let firstDate=new Date(currentYear,currentMonth,1);firstDay=firstDate.getDay()}
const refreshDateSlots=()=>{e(`slot_${currentDay+firstDay}`).classList.remove("isSelected");calculateFirstDay();setNumberOfDays();
for(let i=0;i<42;i++){let slot=e(`slot_${i+1}`);slot.innerHTML="";slot.classList.remove("hoverableDate");slot.onclick = null}
for(let i=1;i<numberOfDays+1;i++){let slot=e(`slot_${i+firstDay}`);slot.innerHTML=i;
let thisDate=new Date(currentYear,currentMonth,i);let d=days[thisDate.getDay()].toLowerCase();
db.collection('operatingHrs').doc(d).get().then((doc)=>{if(doc.data().am==-1&&doc.data().pm==-1||(currentMonth==today.month&&currentYear==today.yr&&i<today.day)||
(thisDate.getDay()==6&&currentCharter==1.5)){slot.classList.add('blocked');slot.classList.remove('hoverableDate')
slot.onclick=()=>{return null}}else{slot.classList.add("hoverableDate");slot.classList.remove('blocked');slot.onclick=()=>{updateCurrentDay(slot.innerHTML)}}})}
if(firstDay==5&&numberOfDays>30||firstDay==6&&numberOfDays>29){e('lastCalendarRow').classList.remove("isHidden");}
else{e('lastCalendarRow').classList.add("isHidden")}}  
const updateCurrentDay=(day)=>{if(currentDay!=0){e(`slot_${currentDay+firstDay}`).classList.remove("isSelected")}
currentDay=Number(day);e(`slot_${currentDay+firstDay}`).classList.add("isSelected");
let selectedDate=new Date(currentYear, currentMonth, currentDay);
let currentDayName=days[selectedDate.getDay()];dateTimeField.innerHTML=`${currentDayName}, ${currentMonth+1}/${currentDay}/${currentYear.toString().substr(2,2)}`;
getAvailableTimes()}
const setOffset=()=>{currentDay=today.day+0;if (currentCharter==1.5&&today.dow+0==6) {
currentDay+=1}if(currentDay>numberOfDays){currentDay=currentDay-numberOfDays;refreshCalendar(true)}
db.collection('operatingHrs').doc(days[new Date(currentYear,currentMonth,currentDay).getDay()].toLowerCase()).get().then((doc)=>{
let d=doc.data();if(d.am==-1&&d.pm==-1){currentDay+=1;setOffset();}})
updateCurrentDay(currentDay)}
const getAvailableTimes=()=>{e('noTimesMsg').classList.add('isHidden');let l="operatingHrs";if(cb==='Sundancer'){l="operatingHrsB"};let currentDate = new Date(currentYear, currentMonth, currentDay);
db.collection(l).doc(days[currentDate.getDay()].toLowerCase()).get().then((doc)=>{
let availability=doc.data().am.toString(2)+padWithZeros(doc.data().pm.toString(2));
if(currentCharter==1.5){let o="0";let n="1"; availability=n.repeat(72)+o.repeat(6)+n.repeat(18)}
db.collection("accepted").where("month", "==", currentMonth).where("year", "==", currentYear).where("day","==",currentDay).get().then((eventsA)=>{
eventsA.forEach((eventA)=>{
db.collection('operatingHrs').doc('prep').get().then((prep)=>{let startPt = (eventA.data().startHr * 4 + eventA.data().startMin/15)-(prep.data().before/15);
availability=fillWithOnes(availability,startPt,eventA.data().duration+prep.data().after+prep.data().before)})})
db.collection("booked").where("month","==",currentMonth).where("year","==",currentYear).where("day", "==", currentDay).get().then((events)=>{
db.collection('operatingHrs').doc('prep').get().then((v)=>{
events.forEach((event)=>{let startPt = (event.data().startHr*4+event.data().startMin / 15) - (v.data().before / 15);
availability=fillWithOnes(availability,startPt,event.data().duration+v.data().after + v.data().before)})
let open=[];let x=4*currentCharter; let zero='0'; let s=zero.repeat(x);
for(let i=0;i<96-x;i+=2){if(availability.substr(i,x)==s){open.push(i)}}
for(let i=1;i<49;i++){document.getElementById(`tSlot${i}`).classList.add('isHidden');
if(open.length==0){e('noTimesMsg').classList.remove('isHidden')}
e(`tSlot${i}`).setAttribute('tid',i)}
let p=open.indexOf(open.find(t=>Math.floor(t/4)>11))
if(doc.data().am===-1&&doc.data().pm===-1){e('noTimesMsg').classList.remove('isHidden');open=[]}
open.map((n,i)=>{let t="AM";let hr=Math.floor(n/4);let min=((n/4)-hr)*60;let o=i+1;
if (hr>11){o=i+25-p;t="PM"}if(hr>=13){hr-=12}if(min==0){min="00"}
if (hr==0){hr="12"} let slot=e(`tSlot${o}`);
slot.innerHTML=`${hr}:${min} ${t}`;slot.setAttribute("hr", Math.floor(n/4));slot.setAttribute("min", min); slot.classList.remove('isHidden');
slot.classList.add('hoverableDate');slot.onclick=()=>{
if(currentSlot!= 0){e(`tSlot${currentSlot}`).classList.remove('isSelected')}
currentSlot=slot.getAttribute('tid');timeField.innerHTML=`at ${slot.innerHTML}`;
slot.classList.add('isSelected'); currentHr=slot.getAttribute('hr');currentMin=slot.getAttribute('min')
}})})})})})}
const fillWithOnes=(text,start,duration)=>{let one='1';let length=duration/15;
let newText=`${text.substr(0,start)}${one.repeat(length)}${text.substr(start+length,96-start-length)}`;
if(newText.length>96){newText=newText.substr(0,96)}
return newText}
const padWithZeros=(text)=>{let zero='0';return (`${zero.repeat(48-text.length)}${text}`)}  
const handleCharterRequest=()=>{let errorExists=true;
if(fnameField.value.length>0&&lnameField.value.length>0&&e('yachtType').value != "blank"
&&numPassengers.value!=""&&dateTimeField.innerHTML.substr(0,6)!="Select"
&&phoneField.value.length==10&&emailField.value!=""&&timeField.innerHTML.length>0
&&(!isNaN(phoneField.value)&&!isNaN(parseFloat(phoneField.value)))){
errorExists=false;e('generalErrorMsg').classList.add("isHidden")}else{ errorExists=true;let errMsg="";
if(dateTimeField.innerHTML.substr(0,6)=="Select"){errMsg="Please specify a date and time."}
else if(phoneField.value.length!=10){errMsg="Phone number must be 10 digits long."}
else if(isNaN(phoneField.value)||isNaN(parseFloat(phoneField.value))){errMsg="Phone number must include only digits."}
else{errMsg="Please make sure all fields are filled and valid."}
e('generalErrorMsg').innerHTML=errMsg;e('generalErrorMsg').classList.remove("isHidden")}
if(!errorExists){prepareFormData();sendNewRequest(form)}}
const prepareFormData=()=>{form.charterType=charterType.value=='1.5'?'Sunset Cruise':`${charterType.value}-Hour Cruise`;
form.firstName=fnameField.value;form.lastName=lnameField.value;form.phone=phoneField.value;form.email=emailField.value;
form.day=currentDay;form.month=currentMonth;form.year=currentYear;form.numPassengers=Number(numPassengers.value);form.notes=notesField.value;
form.duration=currentCharter*60;form.startHr=Number(currentHr);form.startMin=Number(currentMin)
form.whenPretty=e('resDateTime').innerHTML+" "+e('timeField').innerHTML;
form.yachtType=e('yachtType').value}
const sendNewRequest=(data)=>{db.collection("pending").add(data).then((docRef)=>{let r=null;
db.collection('operatingHrs').doc('prices').get().then((doc)=>{let d=doc.data();
if(cb==='Dragonfly'){if(currentCharter=='1.5'){r=d.sun}else if(currentCharter=='2'){r=d.two}
else if(currentCharter=='3'){r=d.three}else if(currentCharter=='4'){r=d.four}
}else{if(currentCharter=='1.5'){r=d.sunB}else if(currentCharter=='2'){r=d.twoB}
else if(currentCharter=='3'){r=d.threeB}else if(currentCharter=='4'){r=d.fourB}} 
db.collection("pending").doc(docRef.id).update({id: docRef.id, rate: Number(r),idt:docRef.id.substr(0,8)}).then(()=>{
window.location.replace('https://sd-yacht-charters.webflow.io/request-submitted')})})})}
let t=new Date();today.day=t.getDate();today.month=t.getMonth();today.yr=t.getFullYear();
today.dow=t.getDay();currentMonth=today.month;currentYear=today.yr;e('leftArrow').classList.add('blocked');
e('calendarMonthYear').innerHTML=months[currentMonth]+" "+currentYear;
calculateFirstDay();setNumberOfDays();refreshDateSlots();left.classList.add("isHidden")
setOffset();e('generalErrorMsg').classList.add("isHidden");for(let i=1;i<49;i++){document.getElementById(`tSlot${i}`).classList.add('isHidden')}
const checkYT=()=>{if(numPassengers.value>6){e('yachtType').selectedIndex=1}cb=e('yachtType').value;getAvailableTimes()}
numPassengers.onchange=()=>{checkYT();getAvailableTimes()}
e('yachtType').onchange=()=>{checkYT();getAvailableTimes()}
e('charterType').selectedIndex=tour_type;
</script>
